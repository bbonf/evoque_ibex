<script>

    // returns selection, but only when it exists wholly inside the "selector" field
    function getSelection() {

        var selection = document.getSelection();

        if (
            selection.anchorNode.parentNode.id == "selector" &&
            selection.focusNode.parentNode.id == "selector" &&
            selection.anchorOffset != selection.focusOffset
        ) {
            // determine start and end character based on anchor (where you click) and focus (where you release)
            start = Math.min(selection.anchorOffset, selection.focusOffset);
            end = Math.max(selection.anchorOffset, selection.focusOffset);

            // clear selection:
            if (selection.removeAllRanges) {
                selection.removeAllRanges();
            } else if (selection.empty) {
                selection.empty();
            }

            return [start, end]

        }
        return null;
    }

    // Called whenever mouse is released
    document.onmouseup = document.onkeyup = function() {

        var sel = getSelection();

        // Only do something if you've actually selected something:
        if ( sel != null ) {

            var text = document.getElementById("selector").innerHTML;

            document.getElementById("selection_start").value = sel[0];
            document.getElementById("selection_end").value = sel[1];
            document.getElementById("selected_text").value = text.substring(sel[0], sel[1]);

            // Add highlighting, store in "highlighter" field displayed behind the "selector".
            document.getElementById("highlighter").innerHTML =
                text.substring(0, sel[0]) +
                '<mark style="color: transparent">' + text.substring(sel[0], sel[1]) + "</mark>" +
                text.substring(sel[1], text.length);
        }
    };

    // Called when clicking a button, to clear highlighting
    function clearSelection() {
        document.getElementById("selection_start").value = "";
        document.getElementById("selection_end").value = "";
        document.getElementById("selected_text").value = "";
        document.getElementById("highlighter").innerHTML = document.getElementById("selector").innerHTML;
    }

</script>

<div style="width: 40em;">
    <p>Here's a story! Please select some text!</p>

    <hr>

    <div style="height: 200pt">
        <div id="highlighter" style="color:transparent; position: absolute; width: 400pt; display: inline-block">
            In publishing and graphic design, lorem ipsum is a placeholder text commonly used to demonstrate the visual form of a document without relying on meaningful content. Replacing the actual content with placeholder text allows designers to design the form of the content before the content itself has been produced. In publishing and graphic design, lorem ipsum is a placeholder text commonly used to demonstrate the visual form of a document without relying on meaningful content. Replacing the actual content with placeholder text allows designers to design the form of the content before the content itself has been produced.
        </div>
        <div id="selector" style="position: absolute; width: 400pt; display: inline-block">
            In publishing and graphic design, lorem ipsum is a placeholder text commonly used to demonstrate the visual form of a document without relying on meaningful content. Replacing the actual content with placeholder text allows designers to design the form of the content before the content itself has been produced. In publishing and graphic design, lorem ipsum is a placeholder text commonly used to demonstrate the visual form of a document without relying on meaningful content. Replacing the actual content with placeholder text allows designers to design the form of the content before the content itself has been produced.
        </div>
    </div>

    <hr>
    <button onclick="clearSelection()">Clear selection</button>

    <br><br><br><br>

    <p>The following form fields ensure the results are saved through e.g. Ibex. The fields are visible only for debugging; to be hidden (not removed) using div style="display: none":</p>
    <!-- below are invisible form fields to which the selection is saved. -->
    <div>
        <textarea id="selection_start" name="selection_start" rows="1" cols="10"></textarea>
        <textarea id="selection_end" name="selection_end" rows="1" cols="10"></textarea>
        <textarea id="selected_text" name="selected_text" rows="2" cols="30"></textarea>
    </div>


</div>
