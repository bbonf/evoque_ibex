<script>

var fragment_phase = "start"
showFragmentStart();

// For loading the first fragment and showing appropriate form fields
async function showFragmentStart() {
    document.getElementById("fragment_highlighter1").innerHTML = fragmentstart;
    document.getElementById("fragment_selector").innerHTML = fragmentstart;
    document.getElementById("fragment_colorizer").innerHTML = fragmentstart;
    await sleep(800);
    document.getElementById("div_containing_form_for_fragment_start").style.display = "block";
    //await sleep(1000);
    //document.getElementById("link_to_show_fragment_cont").style.visibility = "visible";
};


// For showing the fragment continuation, and hiding/showing the appropriate form fields
async function showFragmentCont(e) {

    // TODO form completion and quality check
    if (!qualityCheckFirstPart()) return;

    fragment_phase = "cont";

    // First some cleaning
    if (document.getElementById("question").value == "") {
        // If no question was given, remove highlighting made to avoid polluting the results file.
        document.getElementById("question_highlighting_start").value = "";
        document.getElementById("question_highlighting_end").value = "";
        document.getElementById("question_highlighting").value = "";
    }

    // Slowly scroll to top
    $("html, body").animate({ scrollTop: 0 }, "slow");

    // Hide the clicked link, hide the first part of the form
    document.getElementById("link_to_show_fragment_cont").style.display = "none";
    document.getElementById("div_containing_form_for_fragment_start").style.display = "none";

    // Dim the colors of the first part of the fragment
    await sleep(100)
    document.getElementById("fragment_colorizer").innerHTML = '<font color="#999999">' + fragmentstart + "</font>";
    if (document.getElementById("question").value != "") {
        // this "highlight1" object only exists if a question was entered before.
        document.getElementById("highlight1").style.backgroundColor = "#ffff88";
    }

    // Now load the rest of the fragment
    await sleep(500);
    document.getElementById("fragment_highlighter1").innerHTML += "  " + fragmentcont;
    document.getElementById("fragment_selector").innerHTML += " " + fragmentcont;
    document.getElementById("fragment_colorizer").innerHTML += " " + fragmentcont;

    // The new form
    await sleep(500);
    // Show something different depending on whether a question was evoked.
    if (document.getElementById("question").value != "") {
        document.getElementById("question_copy_for_display").innerHTML = document.getElementById("question").value;
        document.getElementById("div_containing_form_for_fragment_cont").style.display = "block";
    } else {
        document.getElementById("div_containing_message_incase_no_question_was_evoked").style.display = "block";
        document.getElementById("fragment_highlighter2").style.visibility = "hidden";
    }

    // And finally make the final continue link visible
    document.getElementById("div_containing_continue-link").style.visibility = "visible"

};

// For hiding/showing follow-up form fields depending on whether the fragment evokes a question
function toggleQuestionRadio(element) {
    if ( element.id == "radio_question_no" ) {
        document.getElementById("question").readOnly = true;
        document.getElementById("hidden_field_for_storing_question").innerHTML = document.getElementById("question").value;
        document.getElementById("question").value = "";
        document.getElementById("fragment_highlighter1").style.visibility = "hidden";
        document.getElementById("div_containing_item_4").style.visibility = "hidden";
        document.getElementById("question_highlighting_error").style.visibility = "hidden";
    } else {
        if ( document.getElementById("question").readOnly = true ) {
            document.getElementById("question").readOnly = false;
            document.getElementById("question").value = document.getElementById("hidden_field_for_storing_question").innerHTML;
            document.getElementById("hidden_field_for_storing_question").innerHTML = "";
            document.getElementById("fragment_highlighter1").style.visibility = "visible";
            document.getElementById("div_containing_item_4").style.visibility = "visible";
            document.getElementById("question_highlighting_error").style.visibility = "hidden";
        }
    };
};

// For hiding/showing follow-up form fields depending on whether the evoked question was answered
function toggleAnswerRadio(element) {
    if ( element.id == "answered1" || element.id == "answered2" ) {
        document.getElementById("answer").readOnly = true;
        document.getElementById("hidden_field_for_storing_answer").innerHTML = document.getElementById("answer").value;
        document.getElementById("answer").value = "";
        document.getElementById("fragment_highlighter2").style.visibility = "hidden";
        document.getElementById("div_containing_items_6_and_7").style.visibility = "hidden";
        document.getElementById("answer_error").style.visibility = "hidden";
        document.getElementById("answer_highlighting_error").style.visibility = "hidden";
    } else {
        if ( document.getElementById("answer").readOnly == true ) {
            document.getElementById("answer").readOnly = false;
            document.getElementById("answer").value = document.getElementById("hidden_field_for_storing_answer").innerHTML;
            document.getElementById("fragment_highlighter2").style.visibility = "visible";
            document.getElementById("div_containing_items_6_and_7").style.visibility = "visible";
            document.getElementById("answer_error").style.visibility = "hidden";
            document.getElementById("answer_highlighting_error").style.visibility = "hidden";
        }
    };
};


function qualityCheckFirstPart() {
    var check = true;

    document.getElementById("grammaticality_error").style.visibility = "hidden";
    document.getElementById("coherence_error").style.visibility = "hidden";
    document.getElementById("question_error").style.visibility = "hidden";
    document.getElementById("question_highlighting_error").style.visibility = "hidden";
    document.getElementById("div_for_first_error_message").style.visibility = "hidden";

    // Grammaticality
    if (!document.getElementById("grammaticality1").checked &&
        !document.getElementById("grammaticality2").checked &&
        !document.getElementById("grammaticality3").checked &&
        !document.getElementById("grammaticality4").checked &&
        !document.getElementById("grammaticality5").checked) {
        flashMessage(document.getElementById("grammaticality_error"));
        check = false;
    }

    // Coherence
    if (!document.getElementById("coherence1").checked &&
        !document.getElementById("coherence2").checked &&
        !document.getElementById("coherence3").checked &&
        !document.getElementById("coherence4").checked &&
        !document.getElementById("coherence5").checked) {
        flashMessage(document.getElementById("coherence_error"));
        check = false;
    }

    // The question field
    // TODO More sophisticated quality control, e.g., spellcheck, min length, question mark?
    if ( document.getElementById("radio_question_yes").checked && document.getElementById("question").value == "" ) {
        flashMessage(document.getElementById("question_error"));
        check = false;
    }

    // The highlighting
    // TODO More sophisticated quality control, e.g., min words, max words?
    if ( document.getElementById("radio_question_yes").checked && document.getElementById("question_highlighting").value == "" ) {
        flashMessage(document.getElementById("question_highlighting_error"));
        check = false;
    }

    if (!check) flashMessage(document.getElementById("div_for_first_error_message"));
    return check;
}


function FinalQualityCheck() {
    // In case nothing further was required:
    if (document.getElementById("div_containing_message_incase_no_question_was_evoked").style.display == "block") {
        return true;
    }

    // Otherwise, check if all required fields are completed:
    var check = true;

    document.getElementById("answered_error").style.visibility = "hidden";
    document.getElementById("answer_error").style.visibility = "hidden";
    document.getElementById("answer_highlighting_error").style.visibility = "hidden";
    document.getElementById("div_for_last_error_message").style.visibility = "hidden";

    // Answered
    if (!document.getElementById("answered1").checked &&
        !document.getElementById("answered2").checked &&
        !document.getElementById("answered3").checked &&
        !document.getElementById("answered4").checked &&
        !document.getElementById("answered5").checked) {
        flashMessage(document.getElementById("answered_error"));
        check = false;
    }

    // The answer field
    // TODO More sophisticated quality control, e.g., spellcheck, min length, question mark?
    if ((document.getElementById("answered3").checked || document.getElementById("answered4").checked || document.getElementById("answered5").checked)
        && document.getElementById("answer").value == "" ) {
        flashMessage(document.getElementById("answer_error"));
        check = false;
    }

    // The answer highlighting
    // TODO More sophisticated quality control, e.g., min words, max words?
    if ((document.getElementById("answered3").checked || document.getElementById("answered4").checked || document.getElementById("answered5").checked )
        && document.getElementById("answer_highlighting").value == "" ) {
        flashMessage(document.getElementById("answer_highlighting_error"));
        check = false;
    }

    if (!check) flashMessage(document.getElementById("div_for_last_error_message"));
    return check;

}

// returns selection, but only when it exists wholly inside the "selector" field
function getSelection() {

    var selection = document.getSelection();

    if (selection.anchorNode == null) return null;

    if (
        selection.anchorNode.parentNode.id == "fragment_selector" &&
        selection.focusNode.parentNode.id == "fragment_selector" &&
        selection.anchorOffset != selection.focusOffset
    ) {
        // determine start and end character based on anchor (where you click) and focus (where you release)
        start = Math.min(selection.anchorOffset, selection.focusOffset);
        end = Math.max(selection.anchorOffset, selection.focusOffset);

        // Select only whole words.
        var text = document.getElementById("fragment_selector").innerHTML;
        while (start > 0) {
            if (text[start-1] == " " || text[start-1] == "’") {
                break;
            }
            start -= 1;
        }
        while (end < text.length) {
            if (text[end] == " " || text[end] == "," || text[end] == "." || text[end] == ";" || text[end] == ":" || text[end] == ")" || text[end] == "'" || text[end] == '"' || text[end] == "’" || text[end] == "”") {
                break;
            }
            end += 1;
        }

        // clear selection:
        if (selection.removeAllRanges) {
            selection.removeAllRanges();
        } else if (selection.empty) {
            selection.empty();
        }

        // Select only in appropriate region.
        if (fragment_phase == "cont" && start < fragmentstart.length) {
            return null;
        };

        return [start, end];

    }
    return null;
};

// Called whenever mouse is released, used only for grabbing selection
document.onmouseup = document.onkeyup = function() {

    var sel = getSelection();
    // Only do something if you've actually selected something (in the proper field):
    if ( sel != null ) {

        var text = document.getElementById("fragment_selector").innerHTML;

        if (fragment_phase == "start") {
            document.getElementById("question_highlighting_start").value = sel[0];
            document.getElementById("question_highlighting_end").value = sel[1];
            document.getElementById("question_highlighting").value = text.substring(sel[0], sel[1]);

            // Add highlighting, store in "highlighter" field displayed behind the "selector".
            document.getElementById("fragment_highlighter1").innerHTML =
                text.substring(0, sel[0]) +
                '<mark id="highlight1" style="color: transparent">' + text.substring(sel[0], sel[1]) + "</mark>" +
                text.substring(sel[1], text.length);
        } else {
            document.getElementById("answer_highlighting_start").value = sel[0];
            document.getElementById("answer_highlighting_end").value = sel[1];
            document.getElementById("answer_highlighting").value = text.substring(sel[0], sel[1]);

            // Add highlighting, store in "highlighter" field displayed behind the "selector".
            document.getElementById("fragment_highlighter2").innerHTML =
                text.substring(0, sel[0]) +
                '<mark style="color: transparent; background-color: #33ff00">' + text.substring(sel[0], sel[1]) + "</mark>" +
                text.substring(sel[1], text.length);
        }

    }
};


</script>


<!--
<center><button onclick="clearSelection()">clear highlighting</button></center> -->

<div style="width: 40em">

    <hr>
        <div style="height: 120pt">  <!-- TODO More principled way of choosing height -->
            <div id="fragment_highlighter1" style="color:transparent; position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_highlighter2" style="color:transparent; position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_colorizer" style="position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_selector" style="color:transparent; position: relative; width: 40em; display: inline-block"></div>
        </div>
    <hr>


<div id="div_containing_form_for_fragment_start" style="display: none; position: absolute">
    <p>
        <b>1. Is this fragment grammatically correct?</b>
        <b id="grammaticality_error" style="color: red; visibility: hidden">*</b><br>
        <i>Not correct at all.</i>
        <input name="grammaticality" id="grammaticality1" type="radio" value="1">1</input>
        <input name="grammaticality" id="grammaticality2" type="radio" value="2" >2</input>
        <input name="grammaticality" id="grammaticality3" type="radio" value="3" >3</input>
        <input name="grammaticality" id="grammaticality4" type="radio" value="4" >4</input>
        <input name="grammaticality" id="grammaticality5" type="radio" value="5" >5</input>
        <i>Completely correct.</i>
    </p>

    <p>
        <b>2. How coherent is this fragment?</b>
        <b id="coherence_error" style="color: red; visibility: hidden">*</b><br>
        <i>Not coherent at all.</i>
        <input name="coherence" id="coherence1" type="radio" value="1">1</input>
        <input name="coherence" id="coherence2" type="radio" value="2">2</input>
        <input name="coherence" id="coherence3" type="radio" value="3">3</input>
        <input name="coherence" id="coherence4" type="radio" value="4">4</input>
        <input name="coherence" id="coherence5" type="radio" value="5">5</input>
        <i>Completely coherent.</i>
    </p>

    <p>
        <b>3. Does this fragment evoke a question for you?</b>
        <b id="question_error" style="color: red; visibility: hidden">*</b><br>
        <!-- (List up to three questions; leave <i>blank</i> if it does not evoke any questions.) <br> -->
        <input name="radio_question_yesno" id="radio_question_yes" type="radio" value="yes" onclick="toggleQuestionRadio(this)" checked="checked"><i>Yes, namely:</i>
        <input name="question" id="question" type="text" style="width: 33em"><br>
        <input name="radio_question_yesno" id="radio_question_no" type="radio" value="no" onclick="toggleQuestionRadio(this)"><i>No, it doesn't really evoke any question for me.</i>
        <div id="hidden_field_for_storing_question" style="display: none"></div>
        <!-- <input name="q2" type="text" style="width: 40em"></input><br>
        <input name="q3" type="text" style="width: 40em"></input><br> -->
    </p>

    <div id="div_containing_item_4"><p>
        <b>4. Which part of the fragment primarily evokes this question?</b>
        <b id="question_highlighting_error" style="color: red; visibility: hidden">*</b>
        <ul>
            <li>Please <mark>highlight</mark> a phrase in the fragment above (cursor selection).</li>
            <li>To change the highlighting just make a new selection.</li>
            <!-- <li>There's also a button to <i>clear</i> the current highlighting.</li>
            <li>If no phrase seems suitable for marking, do not select anything.</li> -->
        </ul>
<!-- below are invisible form fields to which the selection is saved. -->
        <div style="display: none">
        Selected text:
            <input id="question_highlighting" name="question_highlighting" type="text" style="width: 32em">
            <textarea id="question_highlighting_start" name="question_highlighting_start" rows="1" cols="10"></textarea>
            <textarea id="question_highlighting_end" name="question_highlighting_end" rows="1" cols="10"></textarea>
        </div>
    </p></div>

    <hr>
    <div id="link_to_show_fragment_cont">
        <a href="#!" class="Message-continue-link" id="link_to_show_fragment_cont_ahref" onclick="showFragmentCont()">
        &#8594 Done? Click to save your answers and see how the fragment continues.
        </a><br>
        <div id="div_for_first_error_message" style="color: red; visibility: hidden">
        Please complete the form first.
        </div>
    </div>

</div>

<div id="div_containing_message_incase_no_question_was_evoked" style="position: relative; display: none">
    <p><b>Since for you the first part did not evoke any question, there are no further questions about this fragment. Just click the link below to continue.</b></p>
</div>

<div id="div_containing_form_for_fragment_cont" style="display: none">

    <p><b>You said that the first part evoked the question:</b></font>
        <div id="question_copy_for_display" style="width: 32em; background-color: #eeeeee; border: 1px solid darkgray; box-shadow: 1px 1px 1px 0 lightgray inset; margin-top: 5px; padding: 2px 3px"></div>
    </p>

    <p><b>5. Was your question answered in the continuation?</b>
        <b id="answered_error" style="color: red; visibility: hidden">*</b><br>
        <i>Not answered at all.</i>
        <input name="answered" id="answered1" type="radio" value="1" onclick="toggleAnswerRadio(this)">1</input>
        <input name="answered" id="answered2" type="radio" value="2" onclick="toggleAnswerRadio(this)">2</input>
        <input name="answered" id="answered3" type="radio" value="3" onclick="toggleAnswerRadio(this)">3</input>
        <input name="answered" id="answered4" type="radio" value="4" onclick="toggleAnswerRadio(this)">4</input>
        <input name="answered" id="answered5" type="radio" value="5" onclick="toggleAnswerRadio(this)">5</input>
        <i>Completely answered.</i>
    </p>

    <div id="div_containing_items_6_and_7"><p>
        <b>6. Enter the (suggested, partial) answer in your own words:</b>
        <b id="answer_error" style="color: red; visibility: hidden">*</b><br>
        <input name="answer" id="answer" type="text" style="width: 33em">
        <div id="hidden_field_for_storing_answer" style="display: none"></div>

        <b>7. Which phrase in the new part primarily suggests this answer?</b>
        <b id="answer_highlighting_error" style="color: red; visibility: hidden">*</b><br>
        <ul>
            <li>Please <mark style="background-color: #33ff00">highlight</mark> a phrase in the new part of the fragment above.</li>
            <li>To change the highlighting just make a new selection.</li>
            <!-- <li>There's also a button to <i>clear</i> the current highlighting.</li>
            <li>If no phrase seems suitable for marking, do not select anything.</li> -->
        </ul>
<!-- below are invisible form fields to which the selection is saved. -->
        <div style="display: none">
        Selected text:
            <input id="answer_highlighting" name="answer_highlighting" type="text" style="width: 32em">
            <textarea id="answer_highlighting_start" name="answer_highlighting_start" rows="1" cols="10"></textarea>
            <textarea id="answer_highlighting_end" name="answer_highlighting_end" rows="1" cols="10"></textarea>
        </div>
    </p></div>

    <hr>
    <div id="div_for_last_error_message" style="color: red; visibility: hidden; position: absolute">
    <br><br>Please complete the form first.
    </div>

</div>

</div>