<script>
selector = document.getElementById("fragment_selector");
selector_fromidx = text_thusfar.length;

radio_buttons_yesno = ["evoked"];
// radio_buttons_5 = ["coherence"];
radio_buttons_5 = [];

init();

function revealForm() {

    document.getElementById("form").style.visibility = "visible";

}

// For hiding/showing follow-up form fields depending on whether the fragment evokes a question
function toggleQuestionRadio(element) {
    if ( element.id == "evoked_no" ) {
        document.getElementById("question").disabled = true;
        document.getElementById("hidden_field_for_storing_question").innerHTML = document.getElementById("question").value;
        document.getElementById("question").value = "";
        document.getElementById("fragment_highlighter").style.visibility = "hidden";
        document.getElementById("div_containing_item_4").style.color = "#888888";
        document.getElementById("enter_your_question").style.color = "#888888";
        document.getElementById("marker_in_question").style.backgroundColor = "#E2F1FD";
        document.getElementById("marker_in_question").style.color = "#888888";
        document.getElementById("question_highlighting_error").style.visibility = "hidden";
    } else {
        if ( document.getElementById("question").disabled = true ) {
            document.getElementById("question").disabled = false;
            document.getElementById("question").value = document.getElementById("hidden_field_for_storing_question").innerHTML;
            document.getElementById("hidden_field_for_storing_question").innerHTML = "";
            document.getElementById("fragment_highlighter").style.visibility = "visible";
            document.getElementById("div_containing_item_4").style.color = "#000000";
            document.getElementById("marker_in_question").style.backgroundColor = "#76bef8";
            document.getElementById("marker_in_question").style.color = "#000000";
            document.getElementById("enter_your_question").style.color = "#000000";
            document.getElementById("question_highlighting_error").style.visibility = "hidden";
        }
    };
};

function quality_check() {

    var check = true;

//    document.getElementById("coherence_error").style.visibility = "hidden";
    document.getElementById("question_error").style.visibility = "hidden";
    document.getElementById("question_highlighting_error").style.visibility = "hidden";
    document.getElementById("div_for_first_error_message").style.visibility = "hidden";

    // Coherence
//    if ( !document.getElementById("coherence1").checked &&
//         !document.getElementById("coherence2").checked &&
//         !document.getElementById("coherence3").checked &&
//         !document.getElementById("coherence4").checked &&
//         !document.getElementById("coherence5").checked
//        ) {
//        flashMessage(document.getElementById("coherence_error"));
//        check = false;
//    }

    // The question field
    // TODO More sophisticated quality control, e.g., spellcheck, min length, question mark?
    if ( document.getElementById("evoked_yes").checked &&
         document.getElementById("question").value == ""
        ) {
        flashMessage(document.getElementById("question_error"));
        check = false;
    }

    // The highlighting
    // TODO More sophisticated quality control, e.g., min words, max words?
    if ( document.getElementById("evoked_yes").checked &&
         document.getElementById("selection_text").value == ""
        ) {
        flashMessage(document.getElementById("question_highlighting_error"));
        check = false;
    }

    if (!check) flashMessage(document.getElementById("div_for_first_error_message"));

    // If all is fine
    if (check) {

        // clean up some garbage before sending to server
        if ( document.getElementById("evoked_no").checked ) {
            document.getElementById("question").value = "";
            document.getElementById("selection_text").value = "";
            document.getElementById("selection_start").value = "";
            document.getElementById("selection_end").value = "";
        }

        // Save some results for next screen
        if (document.getElementById("question").value != "") {
            window.questions_thusfar.push(document.getElementById("question").value);
            window.highlights_thusfar.push([document.getElementById("selection_start").value, document.getElementById("selection_end").value]);
        }

        // Slowly scroll to top
        $("html, body").animate({ scrollTop: 0 }, "slow");
    }

    return check;

}

</script>


<!--
<center><button onclick="clearSelection()">clear highlighting</button></center> -->

<div style="width: 40em">
    <hr>
        <div style="height: 120pt">  <!-- TODO More principled way of choosing height -->
            <div id="fragment_highlighter_prev" style="color:transparent; position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_highlighter" style="color:transparent; position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_colorizer" style="position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_selector" style="color:transparent; position: relative; width: 40em; display: inline-block"></div>
        </div>
    <hr>

<div id="form" style="visibility: hidden; width:40em">

    <!-- <p>
        <b>1. Is this fragment comprehensible to you?</b><br>
        <fieldset class="r-pill">
            <div class="r-pill__group">
                <i>&nbsp;&nbsp;Incomprehensible.</i>
                <span class="r-pill__item">
                    <input type="radio" id="coherence1" name="coherence" value="1">
                    <label for="coherence1">1</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence2" name="coherence" value="2">
                    <label for="coherence2">2</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence3" name="coherence" value="3">
                    <label for="coherence3">3</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence4" name="coherence" value="4">
                    <label for="coherence4">4</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence5" name="coherence" value="5">
                    <label for="coherence5">5</label>
                </span>
                <i>Comprehensible.&nbsp;&nbsp;</i>
            </div><b id="coherence_error" style="color: red; visibility: hidden"> *</b>
        </fieldset>
    </p> -->

    <p>
        <b>&#9654; Does the text at this point evoke a question for you?</b><br>
        <!-- (List up to three questions; leave <i>blank</i> if it does not evoke any questions.) <br> -->
        <fieldset class="r-pill">
            <div class="r-pill__group">
                <span class="r-pill__item">
                    <input type="radio" id="evoked_yes" name="evoked" value="1" onclick="toggleQuestionRadio(this)" checked>
                    <label for="evoked_yes">Yes</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="evoked_no" name="evoked" value="0" onclick="toggleQuestionRadio(this)">
                    <label for="evoked_no">No</label>
                </span>
            </div>
        </fieldset>
        <div style="position:absolute; margin-left: 8em; margin-top:-52px"><div id="enter_your_question" style="font-size: small">Your question:</div>
            <div class="r-pill__group"><input name="question" id="question" type="text" style="width: 25em; color:#083851; border-style:none"/></div><b id="question_error" style="color: red; visibility: hidden;"> *</b></div>
    <div id="hidden_field_for_storing_question" style="display: none"></div>
        <!-- <input name="q2" type="text" style="width: 40em"></input><br>
        <input name="q3" type="text" style="width: 40em"></input><br> -->
    </p>

    <div id="div_containing_item_4"><p>
        <b>&#9654; In the fragment, <mark id="marker_in_question" style="background:#76bef8">highlight</mark> the main phrase that evoked this question.</b>
        <b id="question_highlighting_error" style="color: red; visibility: hidden"> *</b>
        <!-- <ul>
            <li>Please  a phrase in the fragment above (cursor selection).</li>
            <li>To change the highlighting just make a new selection.</li>
            <li>There's also a button to <i>clear</i> the current highlighting.</li>
            <li>If no phrase seems suitable for marking, do not select anything.</li>
        </ul>-->
<!-- below are invisible form fields to which the selection is saved. -->
        <div style="display: none">
        Selected text:
            <input id="selection_text" name="question_highlighting" type="text" style="width: 32em">
            <textarea id="selection_start" name="question_highlighting_start" rows="1" cols="10"></textarea>
            <textarea id="selection_end" name="question_highlighting_end" rows="1" cols="10"></textarea>
        </div>
    </p></div>

    <hr>

    <div id="div_for_first_error_message" style="color: red; visibility: hidden">
        Please complete the form first.
    </div>
</div>
</div>