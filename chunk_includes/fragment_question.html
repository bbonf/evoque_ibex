<script>
selector = document.getElementById("fragment_selector");

radio_buttons_yesno = ["evoked"];
// radio_buttons_5 = ["coherence"];
radio_buttons_5 = [];

init();

function revealForm() {

    document.getElementById("marker_in_question").style.backgroundColor = window.colors[window.current_color_idx];
    document.getElementById("question_field").style.backgroundColor = window.colors[window.current_color_idx];
    document.getElementById("form").style.visibility = "visible";

    if(window.questions_thusfar.length > 0) {
        document.getElementById("other").innerHTML = "nother";
    }

}

// For hiding/showing follow-up form fields depending on whether the fragment evokes a question
function toggleQuestionRadio(element) {
    if ( element.id == "evoked_no" ) {
        document.getElementById("question").disabled = true;
        document.getElementById("hidden_field_for_storing_question").innerHTML = document.getElementById("question").value;
        document.getElementById("question").value = "";
        document.getElementById("fragment_highlighter").style.visibility = "hidden";
        document.getElementById("div_containing_item_4").style.color = "#888888";
        document.getElementById("enter_your_question").style.color = "#888888";
        document.getElementById("marker_in_question").style.backgroundColor = colors_dimmed[current_color_idx];
        document.getElementById("marker_in_question").style.color = "#888888";
        document.getElementById("question_highlighting_error").style.visibility = "hidden";
        document.getElementById("question_field").style.backgroundColor = window.colors_dimmed[window.current_color_idx];
    } else {
        if ( document.getElementById("question").disabled = true ) {
            document.getElementById("question").disabled = false;
            document.getElementById("question").value = document.getElementById("hidden_field_for_storing_question").innerHTML;
            document.getElementById("hidden_field_for_storing_question").innerHTML = "";
            document.getElementById("fragment_highlighter").style.visibility = "visible";
            document.getElementById("div_containing_item_4").style.color = "#000000";
            document.getElementById("marker_in_question").style.backgroundColor = colors[current_color_idx];
            document.getElementById("marker_in_question").style.color = "#000000";
            document.getElementById("enter_your_question").style.color = "#000000";
            document.getElementById("question_highlighting_error").style.visibility = "hidden";
            document.getElementById("question_field").style.backgroundColor = window.colors[window.current_color_idx];
        }
    };
};

function quality_check() {

    var check = true;

//    document.getElementById("coherence_error").style.visibility = "hidden";
    document.getElementById("question_error").style.visibility = "hidden";
    document.getElementById("question_highlighting_error").style.visibility = "hidden";
    document.getElementById("div_for_first_error_message").style.visibility = "hidden";

    // Coherence
//    if ( !document.getElementById("coherence1").checked &&
//         !document.getElementById("coherence2").checked &&
//         !document.getElementById("coherence3").checked &&
//         !document.getElementById("coherence4").checked &&
//         !document.getElementById("coherence5").checked
//        ) {
//        flashMessage(document.getElementById("coherence_error"));
//        check = false;
//    }

    // The question field
    // TODO More sophisticated quality control, e.g., spellcheck, min length, question mark?
    if ( document.getElementById("evoked_yes").checked &&
         document.getElementById("question").value == ""
        ) {
        flashMessage(document.getElementById("question_error"));
        check = false;
    }

    // The highlighting
    // TODO More sophisticated quality control, e.g., min words, max words?
    if ( document.getElementById("evoked_yes").checked &&
         document.getElementById("selection_text").value == ""
        ) {
        flashMessage(document.getElementById("question_highlighting_error"));
        check = false;
    }

    if (!check) flashMessage(document.getElementById("div_for_first_error_message"));

    // If all is fine
    if (check) {

        // clean up some garbage before sending to server
        if ( document.getElementById("evoked_no").checked ) {
            document.getElementById("question_index").remove();
            document.getElementById("question").remove();
            document.getElementById("selection_text").remove();
            document.getElementById("selection_start").remove();
            document.getElementById("selection_end").remove();
        } else {    // Save some results for next screen
            start = document.getElementById("selection_start").value.split(",")
            end = document.getElementById("selection_end").value.split(",")
            window.questions_thusfar.push([Number(start[0]), Number(start[1]), Number(end[0]), Number(end[1]), current_color_idx, document.getElementById("question").value, false]);
            document.getElementById("question_index").value = window.questions_thusfar.length - 1;
        }

        window.current_question_idx = window.questions_thusfar.length - 1;    // Always start counting from the most recent one

        // Slowly scroll to top
        $("html, body").animate({ scrollTop: 0 }, "slow");
    }

    return check;

}

</script>


<!--
<center><button onclick="clearSelection()">clear highlighting</button></center> -->

<div style="width: 40em">
    <hr>
        <div id="fragment_scroller" style="overflow: auto; width: 480pt; height: 200pt">
            <div style="position: relative; width: 90%">  <!-- TODO More principled way of choosing height -->
                <div id="answer_highlighter_prev" style="color:transparent; position: absolute; display: inline-block; width:95%"></div>
                <div id="question_highlighter_prev" style="color:transparent; position: absolute; display: inline-block; width:95%"></div>
                <div id="fragment_highlighter" style="color:transparent; position: absolute; display: inline-block; width:95%"></div>
                <div id="fragment_colorizer" style="position: absolute; display: inline-block; width:95%"></div>
                <div id="fragment_selector" style="color:transparent; position: absolute; display: inline-block; width:95%"></div>
            </div>
        </div>
    <hr>

    <input type="text" id="question_index" name="question_index" style="display:none"/>

<div id="form" style="visibility: hidden; width:40em">

    <!-- <p>
        <b>1. Is this fragment comprehensible to you?</b><br>
        <fieldset class="r-pill">
            <div class="r-pill__group">
                <i>&nbsp;&nbsp;Incomprehensible.</i>
                <span class="r-pill__item">
                    <input type="radio" id="coherence1" name="coherence" value="1">
                    <label for="coherence1">1</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence2" name="coherence" value="2">
                    <label for="coherence2">2</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence3" name="coherence" value="3">
                    <label for="coherence3">3</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence4" name="coherence" value="4">
                    <label for="coherence4">4</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="coherence5" name="coherence" value="5">
                    <label for="coherence5">5</label>
                </span>
                <i>Comprehensible.&nbsp;&nbsp;</i>
            </div><b id="coherence_error" style="color: red; visibility: hidden"> *</b>
        </fieldset>
    </p> -->

    <p>
        <b>&#9654; Does the excerpt at this point evoke a<span id="other"></span> question for you?</b><br>
        <!-- (List up to three questions; leave <i>blank</i> if it does not evoke any questions.) <br> -->
        <fieldset class="r-pill">
            <div class="r-pill__group">
                <span class="r-pill__item">
                    <input type="radio" id="evoked_yes" name="evoked" value="1" onclick="toggleQuestionRadio(this)" checked>
                    <label for="evoked_yes">Yes</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="evoked_no" name="evoked" value="0" onclick="toggleQuestionRadio(this)">
                    <label for="evoked_no">No</label>
                </span>
            </div>
        </fieldset>
        <div style="position:absolute; margin-left: 8em; margin-top:-52px"><div id="enter_your_question" style="font-size: small">Your question:</div>
            <div class="r-pill__group" id="question_field"><input name="question" id="question" type="text" style="width: 25em; border-style:none; background-color:transparent"/></div><b id="question_error" style="color: red; visibility: hidden;"> *</b></div>
    <div id="hidden_field_for_storing_question" style="display: none"></div>
        <!-- <input name="q2" type="text" style="width: 40em"></input><br>
        <input name="q3" type="text" style="width: 40em"></input><br> -->
    </p>

    <div id="div_containing_item_4"><p>
        <b>&#9654; In the excerpt, <mark id="marker_in_question" style="background:#76bef8">highlight</mark> the main phrase that evokes this question.</b>
        <b id="question_highlighting_error" style="color: red; visibility: hidden"> *</b>
        <!-- <ul>
            <li>Please  a phrase in the fragment above (cursor selection).</li>
            <li>To change the highlighting just make a new selection.</li>
            <li>There's also a button to <i>clear</i> the current highlighting.</li>
            <li>If no phrase seems suitable for marking, do not select anything.</li>
        </ul>-->
<!-- below are invisible form fields to which the selection is saved. -->
        <div style="display: none">
        Selected text:
            <input id="selection_text" name="question_highlighting" type="text" style="width: 32em">
            <textarea id="selection_start" name="question_highlighting_start" rows="1" cols="10"></textarea>
            <textarea id="selection_end" name="question_highlighting_end" rows="1" cols="10"></textarea>
        </div>
    </p></div>

    <hr>

    <div id="div_for_first_error_message" style="color: red; visibility: hidden">
        Please complete the form first.
    </div>
</div>
</div>