<script>
var selector = document.getElementById("fragment_selector");
var selector_fromidx = textthusfar.length;
var radio_buttons_yesno = [];
var radio_buttons_5 = ["answered"];

reveal();

async function reveal() {
    document.getElementById("fragment_highlighter_prev").innerHTML = window.textthusfar;
    document.getElementById("fragment_selector").innerHTML = window.textthusfar;
    document.getElementById("fragment_colorizer").innerHTML = window.textthusfar;

    // Dim the colors of the first part of the fragment
    document.getElementById("fragment_colorizer").innerHTML = '<font color="#888888">' + window.textthusfar + "</font>";
    if (window.question != "") {
        // this "highlight1" object only exists if a question was entered before.
        document.getElementById("fragment_highlighter_prev").innerHTML =
                window.textthusfar.substring(0, window.question_highlighting_start) +
                '<mark id="highlight1" style="color: transparent; background-color: #76bef8">' + window.textthusfar.substring(window.question_highlighting_start, window.question_highlighting_end) + "</mark>" +
                window.textthusfar.substring(window.question_highlighting_end, window.textthusfar.length);
        document.getElementById("highlight1").style.backgroundColor = "#E2F1FD";
    }

    // Now load the rest of the fragment
    document.getElementById("fragment_highlighter_prev").innerHTML += "  " + window.text;
    document.getElementById("fragment_selector").innerHTML += " " + window.text;
    await addTypedText(document.getElementById("fragment_colorizer"), " " + window.text);

    // The new form
    // Show something different depending on whether a question was evoked.
    if (window.question != "") {
        document.getElementById("question_copy_for_display").innerHTML = window.question;
        document.getElementById("div_containing_form_for_fragment_cont").style.visibility = "visible";
    } else {
        document.getElementById("div_containing_message_incase_no_question_was_evoked").style.display = "block";
        document.getElementById("div_containing_form_for_fragment_cont").style.display = "none";
        document.getElementById("fragment_highlighter").style.visibility = "hidden";
    }

    // And finally make the final continue link visible
    document.getElementById("div_containing_continue-link").style.visibility = "visible"

};

// For hiding/showing follow-up form fields depending on whether the evoked question was answered
function toggleAnswerRadio(element) {
    if ( element.id == "answered1" || element.id == "answered2" ) {
        document.getElementById("answer").disabled = true;
        document.getElementById("hidden_field_for_storing_answer").innerHTML = document.getElementById("answer").value;
        document.getElementById("answer").value = "";
        document.getElementById("fragment_highlighter").style.visibility = "hidden";
        document.getElementById("div_containing_items_6_and_7").style.color = "#888888";
        document.getElementById("answer_error").style.visibility = "hidden";
        document.getElementById("answer_highlighting_error").style.visibility = "hidden";
        document.getElementById("marker_in_question2").style.backgroundColor = "#E2F1FD";
        document.getElementById("marker_in_question2").style.color = "#888888";
    } else {
        if ( document.getElementById("answer").disabled == true ) {
            document.getElementById("answer").disabled = false;
            document.getElementById("answer").value = document.getElementById("hidden_field_for_storing_answer").innerHTML;
            document.getElementById("fragment_highlighter").style.visibility = "visible";
            document.getElementById("div_containing_items_6_and_7").style.color = "#000000";
            document.getElementById("answer_error").style.visibility = "hidden";
            document.getElementById("answer_highlighting_error").style.visibility = "hidden";
            document.getElementById("marker_in_question2").style.backgroundColor = "#76bef8";
            document.getElementById("marker_in_question2").style.color = "#000000";
        }
    };
};


function quality_check() {

    // In case nothing further was required:
    if (window.question == "") {
        document.getElementById("answer").value = "";
        document.getElementById("selection_text").value = "";
        document.getElementById("selection_start").value = "";
        document.getElementById("selection_end").value = "";
        return true;
    }

    // Otherwise, check if all required fields are completed:
    var check = true;

    document.getElementById("answered_error").style.visibility = "hidden";
    document.getElementById("answer_error").style.visibility = "hidden";
    document.getElementById("answer_highlighting_error").style.visibility = "hidden";
    document.getElementById("div_for_last_error_message").style.visibility = "hidden";

    // Answered
    if (!document.getElementById("answered1").checked &&
        !document.getElementById("answered2").checked &&
        !document.getElementById("answered3").checked &&
        !document.getElementById("answered4").checked &&
        !document.getElementById("answered5").checked) {
        flashMessage(document.getElementById("answered_error"));
        check = false;
    }

    // The answer field
    // TODO More sophisticated quality control, e.g., spellcheck, min length, question mark?
    if (!document.getElementById("answered1").checked && !document.getElementById("answered2").checked && document.getElementById("answer").value == "" ) {
        flashMessage(document.getElementById("answer_error"));
        check = false;
    }

    // The answer highlighting
    // TODO More sophisticated quality control, e.g., min words, max words?
    if (!document.getElementById("answered1").checked && !document.getElementById("answered2").checked && document.getElementById("selection_text").value == "" ) {
        flashMessage(document.getElementById("answer_highlighting_error"));
        check = false;
    }

    if (!check) flashMessage(document.getElementById("div_for_last_error_message"));

    // If all is fine, clean up some garbage before sending to server
    if (check) {
        if (document.getElementById("answered1").checked || document.getElementById("answered2").checked) {
            document.getElementById("answer").value = "";
            document.getElementById("selection_text").value = "";
            document.getElementById("selection_start").value = "";
            document.getElementById("selection_end").value = "";
        }
    }

    return check;

}


</script>


<style>
/** Thanks to https://github.com/scottaohara/a11y_styled_form_controls
 * Shared styling among the different form controls.
 * Much of these styles are pulled from normalize.css.
 * Use as necessary within your own style sheets.
 */

input,
button,
textarea,
select {
	border-radius: 0; /* may change, but start consistently */
	box-sizing: border-box;
	font-family: inherit;
	font-size: inherit;
	font-weight: inherit;
	line-height: normal;
	margin: 0;
	overflow: visible; /* show overflow in Edge */
	text-transform: none; /* remove inheritance Edge, Firefox, IE */
}

/**
 * Remove the Clear button added by MS browsers
 */
input::-ms-clear {
	display: none;
	height: 0;
	width: 0;
}


/**
 * <button> Focus Normalization:
 * remove FireFox specific inner focus styles.
 * focus style will be reapplied later.
 */
button::-moz-focus-inner {
	border-style: none;
	padding: 0;
}


/* parent container <fieldset> */
.r-pill {
	border: 0;
	padding: 0;
	margin: 0;
}

/*
	Optional inner wrapper (<div>) to provide additional styling.
*/
.r-pill__group {
	background: #fafafa;
	border: 1px solid #083851;
	border-radius: 2em;
	display: inline-block;
	padding: .25em;
}

.r-pill__item {
	display: inline-block;
	position: relative;
}

.r-pill input {
	-webkit-appearance: none;
	-moz-appearance: none;
	appearance: none;
	background: none;
	border: 2px solid;
	height: 100%;
	left: 0;
	opacity: .00001;
	position: absolute;
	top: 0;
	width: 100%;
	z-index: 2;
}

.r-pill__item label {
	border-radius: 2em;
	border: 2px solid transparent;
	color: #083851;
	display: block;
	padding: .25em .75em;
}

.r-pill__item input:hover ~ label,
.r-pill__item label:hover {
	background: #E2F1FD;
	border-color: #2196f3;
}

.r-pill[disabled] .r-pill__item input:checked + label:hover,
.r-pill__item input:checked + label {
	background: #2196f3;
	color: #fff;
}

.r-pill__item label:after {
	border: 2px solid;
	border-color: rgba(0,0,0,0);
	border-radius: 2em;
	bottom: 0;
	content: "";
	left: 0;
	pointer-events: none; /* 1 */
	position: absolute;
	right: 0;
	top: 0;
	transition:
		bottom .2s ease-in-out,
		border-color .2s ease-in-out,
		left .2s ease-in-out,
		right .2s ease-in-out,
		top .2s ease-in-out;
	/*
		1. Don't like pointer-events?
			 then use z-index: -1;
			 but we don't want this getting in the way
			 of touch / mouse clicks.
	*/
}

.r-pill__item input:focus ~ label:after  {
	border-color: #2196f3;
	bottom: -.25em;
	left: -.25em;
	right: -.25em;
	top: -.25em;
}


/**
 * Disabled
 */
.r-pill[disabled],
.r-pill__item input[disabled] + label {
	opacity: .5;
}

.r-pill__item input[disabled] ~ label,
.r-pill__item input[disabled] ~ label:hover,
.r-pill[disabled] label:hover {
	background: transparent;
	border-color: transparent;
	cursor: not-allowed;
}


/**
 * Undo styling that makes these pills appear as
 * if they are all checked in high contrast mode.
 */
@media screen and (-ms-high-contrast: active) {
	.r-pill__item label {
		border: 0;
		margin: 2px;
	}

	.r-pill__item input:checked + label {
		border: 2px solid;
		margin: 0;
	}

	.r-pill__item input:hover ~ label,
	.r-pill__item label:hover {
		text-decoration: underline;
	}

	.r-pill[disabled] .r-pill__item label:hover,
	.r-pill[disabled] .r-pill__item input:hover ~ label {
		text-decoration: none
	}
}
</style>


<!--
<center><button onclick="clearSelection()">clear highlighting</button></center> -->

<div style="width: 40em">
    <hr>
        <div style="height: 120pt">  <!-- TODO More principled way of choosing height -->
            <div id="fragment_highlighter_prev" style="color:transparent; position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_highlighter" style="color:transparent; position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_colorizer" style="position: absolute; width: 40em; display: inline-block"></div>
            <div id="fragment_selector" style="color:transparent; position: relative; width: 40em; display: inline-block"></div>
        </div>
    <hr>


<div id="div_containing_message_incase_no_question_was_evoked" style="position: relative; display: none">
    <p><b>Based on your responses we have no further questions about this fragment.</b></p>
</div>

<div id="div_containing_form_for_fragment_cont" style="visibility:hidden; width:40em">

    <p><b>For you, the first part evoked the following question:</b>
        <div class="r-pill__group" style="background-color: #eeeeee"><div id="question_copy_for_display" style="width: 32em"></div></div>
        <!-- "width: 32em; background-color: #eeeeee; border: 1px solid darkgray; box-shadow: 1px 1px 1px 0 lightgray inset; margin-top: 5px; padding: 2px 3px" -->
    </p>

    <p><b>4. Was your question answered in the continuation?</b><br>
        <fieldset class="r-pill">
            <div class="r-pill__group">
                <i>&nbsp;&nbsp;Not answered at all.</i>
                <!-- Ugly way of having default value empty string for radio buttons: TODO field can end up twice in results -->
                <input type="text" id="answered0" name="answered" value="" style="display:none"/>
                <span class="r-pill__item">
                    <input type="radio" id="answered1" name="answered" value="1" onclick="toggleAnswerRadio(this)"/>
                    <label for="answered1">1</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered2" name="answered" value="2" onclick="toggleAnswerRadio(this)" />
                    <label for="answered2">2</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered3" name="answered" value="3" onclick="toggleAnswerRadio(this)" />
                    <label for="answered3">3</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered4" name="answered" value="4" onclick="toggleAnswerRadio(this)" />
                    <label for="answered4">4</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered5" name="answered" value="5" onclick="toggleAnswerRadio(this)" />
                    <label for="answered5">5</label>
                </span>
                <i>Completely answered.&nbsp;&nbsp;</i>
            </div><b id="answered_error" style="color: red; visibility: hidden"> *</b>
        </fieldset>
    </p>

    <div id="div_containing_items_6_and_7"><p>
        <b>5. Enter the (complete/partial) answer in your own words:</b><br>
        <div class="r-pill__group"><input name="answer" id="answer" type="text" style="width: 33em; color:#083851; border-style:none" /></div><b id="answer_error" style="color: red; visibility: hidden"> *</b>
        <div id="hidden_field_for_storing_answer" style="display: none"></div>
        </p>

        <p>
        <b>6. In the fragment, <mark id="marker_in_question2" style="background:#76bef8">highlight</mark> the main phrase suggesting this answer.</b>
        <b id="answer_highlighting_error" style="color: red; visibility: hidden"> *</b><br>
        <!-- <ul>
            <li>Please  a phrase in the new part of the fragment above.</li>
            <li>To change the highlighting just make a new selection.</li>
            <li>There's also a button to <i>clear</i> the current highlighting.</li>
            <li>If no phrase seems suitable for marking, do not select anything.</li>
        </ul> -->
<!-- below are invisible form fields to which the selection is saved. -->
        <div style="display: none">
        Selected text:
            <input id="selection_text" name="answer_highlighting" type="text" style="width: 32em">
            <textarea id="selection_start" name="answer_highlighting_start" rows="1" cols="10"></textarea>
            <textarea id="selection_end" name="answer_highlighting_end" rows="1" cols="10"></textarea>
        </div>
    </p></div>

    <hr>
    <div id="div_for_last_error_message" style="color: red; visibility: hidden">
    Please complete the form first.
    </div>

</div>

</div>