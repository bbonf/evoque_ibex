<script>
selector = document.getElementById("fragment_selector");

radio_buttons_yesno = [];
radio_buttons_5 = ["answered"];

init();

function revealForm() {

    document.getElementById("marker_in_question2").style.backgroundColor = window.colors[window.current_color_idx];
    document.getElementById("question_display_field").style.backgroundColor = window.colors_dimmed[window.current_color_idx];
    document.getElementById("answer_field").style.backgroundColor = window.colors[window.current_color_idx];

    // Show something different depending on whether a question was evoked.
    if (window.questions_thusfar.length > 0) {
        // Consider only the most recent question
        // TODO Allow for multiple open questions
        var prev_question = window.questions_thusfar[questions_thusfar.length-1];
        document.getElementById("question_copy_for_display").innerHTML = prev_question;
        document.getElementById("div_containing_form_for_fragment_cont").style.visibility = "visible";
    } else {
        if (window.can_skip) {    // If this can be skipped if no further questions:
            document.getElementById("continue_link").click();
        } else {
            document.getElementById("div_containing_message_incase_no_question_was_evoked").style.display = "block";
            document.getElementById("div_containing_form_for_fragment_cont").style.visibility = "hidden";
            document.getElementById("div_containing_form_for_fragment_cont").style.display = "none";
            document.getElementById("fragment_highlighter").style.visibility = "hidden";
        }
    }

};

// For hiding/showing follow-up form fields depending on whether the evoked question was answered
function toggleAnswerRadio(element) {
    if ( element.id == "answered1" || element.id == "answered2" ) {
        document.getElementById("answer").disabled = true;
        document.getElementById("hidden_field_for_storing_answer").innerHTML = document.getElementById("answer").value;
        document.getElementById("answer").value = "";
        document.getElementById("fragment_highlighter").style.visibility = "hidden";
        document.getElementById("div_containing_items_6_and_7").style.color = "#888888";
        document.getElementById("answer_error").style.visibility = "hidden";
        document.getElementById("answer_highlighting_error").style.visibility = "hidden";
        document.getElementById("marker_in_question2").style.backgroundColor = window.colors_dimmed[window.current_color_idx];
        document.getElementById("marker_in_question2").style.color = "#888888";
        document.getElementById("answer_field").style.backgroundColor = window.colors_dimmed[window.current_color_idx];
    } else {
        if ( document.getElementById("answer").disabled == true ) {
            document.getElementById("answer").disabled = false;
            document.getElementById("answer").value = document.getElementById("hidden_field_for_storing_answer").innerHTML;
            document.getElementById("fragment_highlighter").style.visibility = "visible";
            document.getElementById("div_containing_items_6_and_7").style.color = "#000000";
            document.getElementById("answer_error").style.visibility = "hidden";
            document.getElementById("answer_highlighting_error").style.visibility = "hidden";
            document.getElementById("marker_in_question2").style.backgroundColor = window.colors[window.current_color_idx];
            document.getElementById("marker_in_question2").style.color = "#000000";
            document.getElementById("answer_field").style.backgroundColor = window.colors[window.current_color_idx];
        }
    };
};


function quality_check() {

    // In case nothing further was required:
    if (document.getElementById("div_containing_form_for_fragment_cont").style.visibility != "visible") {
        document.getElementById("answer").value = "";
        document.getElementById("selection_text").value = "";
        document.getElementById("selection_start").value = "";
        document.getElementById("selection_end").value = "";
        return true;
    }

    // Otherwise, check if all required fields are completed:
    var check = true;

    document.getElementById("answered_error").style.visibility = "hidden";
    document.getElementById("answer_error").style.visibility = "hidden";
    document.getElementById("answer_highlighting_error").style.visibility = "hidden";
    document.getElementById("div_for_last_error_message").style.visibility = "hidden";

    // Answered
    if ( !document.getElementById("answered1").checked &&
         !document.getElementById("answered2").checked &&
         !document.getElementById("answered3").checked &&
         !document.getElementById("answered4").checked &&
         !document.getElementById("answered5").checked
       ) {
        flashMessage(document.getElementById("answered_error"));
        check = false;
    }

    // The answer field
    // TODO More sophisticated quality control, e.g., spellcheck, min length, question mark?
    if ( !document.getElementById("answered1").checked &&
         !document.getElementById("answered2").checked &&
         document.getElementById("answer").value == ""
       ) {
        flashMessage(document.getElementById("answer_error"));
        check = false;
    }

    // The answer highlighting
    // TODO More sophisticated quality control, e.g., min words, max words?
    if ( !document.getElementById("answered1").checked &&
         !document.getElementById("answered2").checked &&
         document.getElementById("selection_text").value == ""
        ) {
        flashMessage(document.getElementById("answer_highlighting_error"));
        check = false;
    }

    if (!check) flashMessage(document.getElementById("div_for_last_error_message"));

    // If all is fine
    if (check) {
        // Clean up some garbage before sending to server
        if (document.getElementById("answered1").checked || document.getElementById("answered2").checked) {
            document.getElementById("answer").value = "";
            document.getElementById("selection_text").value = "";
            document.getElementById("selection_start").value = "";
            document.getElementById("selection_end").value = "";
        }

        // Save some results for next screen
        if (document.getElementById("answer").value != "") {
            window.answer_highlights_thusfar.push([document.getElementById("selection_start").value, document.getElementById("selection_end").value, current_color_idx]);
        }

        // Slowly scroll to top
        $("html, body").animate({ scrollTop: 0 }, "slow");
    }

    return check;

}


</script>



<!--
<center><button onclick="clearSelection()">clear highlighting</button></center> -->

<div style="width: 40em">
    <hr>
        <div id="fragment_scroller" style="overflow: auto; width: 480pt; height: 100pt">
            <div style="position: relative; width: 90%">  <!-- TODO More principled way of choosing height -->
                <div id="question_highlighter_prev" style="color:transparent; position: absolute; display: inline-block"></div>
                <div id="answer_highlighter_prev" style="color:transparent; position: absolute; display: inline-block"></div>
                <div id="fragment_highlighter" style="color:transparent; position: absolute; display: inline-block"></div>
                <div id="fragment_colorizer" style="position: absolute; display: inline-block"></div>
                <div id="fragment_selector" style="color:transparent; position: absolute; display: inline-block"></div>
            </div>
        </div>
    <hr>


<div id="div_containing_message_incase_no_question_was_evoked" style="position: relative; display: none">
    <p><b>Based on your responses we have no further questions about this fragment.</b></p>
</div>

<div id="div_containing_form_for_fragment_cont" style="visibility:hidden; width:40em">

    <p><b>For you, the first part evoked the following question:</b>
        <div class="r-pill__group" style="background-color: #eeeeee" id="question_display_field"><div id="question_copy_for_display" style="width: 32em"></div></div>
        <!-- "width: 32em; background-color: #eeeeee; border: 1px solid darkgray; box-shadow: 1px 1px 1px 0 lightgray inset; margin-top: 5px; padding: 2px 3px" -->
    </p>

    <p><b>&#9654; Was your question answered in the continuation?</b><br>
        <fieldset class="r-pill">
            <div class="r-pill__group">
                <i>&nbsp;&nbsp;Not answered at all.</i>
                <!-- Ugly way of having default value empty string for radio buttons: TODO field can end up twice in results -->
                <input type="text" id="answered0" name="answered" value="" style="display:none"/>
                <span class="r-pill__item">
                    <input type="radio" id="answered1" name="answered" value="1" onclick="toggleAnswerRadio(this)"/>
                    <label for="answered1">1</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered2" name="answered" value="2" onclick="toggleAnswerRadio(this)" />
                    <label for="answered2">2</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered3" name="answered" value="3" onclick="toggleAnswerRadio(this)" />
                    <label for="answered3">3</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered4" name="answered" value="4" onclick="toggleAnswerRadio(this)" />
                    <label for="answered4">4</label>
                </span>
                <span class="r-pill__item">
                    <input type="radio" id="answered5" name="answered" value="5" onclick="toggleAnswerRadio(this)" />
                    <label for="answered5">5</label>
                </span>
                <i>Completely answered.&nbsp;&nbsp;</i>
            </div><b id="answered_error" style="color: red; visibility: hidden"> *</b>
        </fieldset>
    </p>

    <div id="div_containing_items_6_and_7"><p>
        <b>&#9654; Enter the (complete/partial) answer in your own words:</b><br>
        <div class="r-pill__group" id="answer_field"><input name="answer" id="answer" type="text" style="width: 33em; border-style:none; background-color:transparent" /></div><b id="answer_error" style="color: red; visibility: hidden"> *</b>
        <div id="hidden_field_for_storing_answer" style="display: none"></div>
        </p>

        <p>
        <b>&#9654; In the fragment, <mark id="marker_in_question2" style="background:#76bef8">highlight</mark> the main phrase suggesting this answer.</b>
        <b id="answer_highlighting_error" style="color: red; visibility: hidden"> *</b><br>
        <!-- <ul>
            <li>Please  a phrase in the new part of the fragment above.</li>
            <li>To change the highlighting just make a new selection.</li>
            <li>There's also a button to <i>clear</i> the current highlighting.</li>
            <li>If no phrase seems suitable for marking, do not select anything.</li>
        </ul> -->
<!-- below are invisible form fields to which the selection is saved. -->
        <div style="display: none">
        Selected text:
            <input id="selection_text" name="answer_highlighting" type="text" style="width: 32em">
            <textarea id="selection_start" name="answer_highlighting_start" rows="1" cols="10"></textarea>
            <textarea id="selection_end" name="answer_highlighting_end" rows="1" cols="10"></textarea>
        </div>
    </p></div>

    <hr>
    <div id="div_for_last_error_message" style="color: red; visibility: hidden">
    Please complete the form first.
    </div>

</div>

</div>